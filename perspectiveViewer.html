<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>iiif Perspective Viewer</title>
  <style type="text/css">
    html, body { height:100%; margin:0; }
    body { background:#000; font:14px/1 helvetica,arial,freesans,sans-serif; }
    .parallaxer { height:100%; width:100%; }
  </style>	
</head>

<body>

<div class="parallaxer js-parallaxer"></div>

<script src="img/manifesto.bundle.js"></script>
<script src="img/openseadragon.min.js"></script>
<script type="text/javascript">
const viewer = {
  id: 1,
  init: (el) => {
    el.id = el.id || 'viewer' + viewer.id++;
    el.osd = OpenSeadragon({
      id: el.id,
      prefixUrl: "https://openseadragon.github.io/openseadragon/images/"
    });
    el.scale = 1;
    el.xlate = null;
    el.paint = () => {
      //~ let scalePlus = 0;
      //~ if (el.scale > 6) { scalePlus = (el.scale - 6) / 30; }
      let layer = null;
      for (let i = 1; i < el.osd.world.getItemCount(); i++) {
        //~ css += `#${el.id} :nth-child(${i}){ transform: scale(${.5 + (el.scale * i * i / 100) + scalePlus}) translate(${-el.xlate[0] * i * i}%  , ${-el.xlate[1] * i * i}%); filter:blur(${i * i * el.scale / 300}px) }`;
        layer = el.osd.world.getItemAt(i);
        //~ console.log(layer.imageToViewerElementCoordinates());
        layer.setPosition(new OpenSeadragon.Point(.5 - (i * i * el.xlate.x), .5 - (i * i * el.xlate.y)));
        //~ layer.setHeight(100);
      }
    };
    el.osd.addHandler('pan', function (data) {
      //~ console.log(data.center.x);
      el.xlate = data.center;
      el.paint();
    });
    el.osd.addHandler('zoom', function (data) {
      //~ console.log(data);
      //~ el.paint();
    });
  }
};

const parallaxer = document.querySelector(".js-parallaxer");

const qstr = new Map(location.search.slice(1).split('&').map(kv => kv.split('=')));
//~ let m = 'https://iiif.vam.ac.uk/demos/peepshow/manifest.json';
let m = 'https://iiif.vam.ac.uk/collections/MSL:1876:Forster:141:I/manifest.json';

if (!qstr.has('manifest')) {
  document.location.search = 'manifest=' + m;
} else {
  m = qstr.get('manifest');
}
manifesto.loadManifest(m).then((manifest) => {
  const mf = manifesto.create(manifest);
  const cvs = mf.getSequences()[0].getCanvases();
  viewer.init(parallaxer);
  i=0;//~ limit for testing
  Array.from(cvs, (cv) => {
    if(++i>3) return;//~ limit for testing
    //~ png support https://github.com/openseadragon/openseadragon/pull/1625
    parallaxer.osd.addTiledImage({
      tileSource: `${cv.getContent()[0].getBody()[0].getServices()[0].id}/info.json`,
      tileFormat: 'png'
    });
    //~ if (cv.getImages().length) {
      //~ im.src = cv.getImages()[0].getResource().id;
    //~ } else if (cv.getContent().length) {
      //~ im.src = cv.getContent()[0].getBody()[0].id;
    //~ }
  });
});
</script>
</body>
</html>
